L.Mixin.Selectable={includes:L.Mixin.Events,setSelected:function(e){var t=!!e;this._selected!==t&&(this._selected=t,this.fire("selected"))},isSelected:function(){return!!this._selected}},L.Mixin.Selection={includes:L.Mixin.Events,getSelection:function(){return this._selected},setSelection:function(e){this._selected===e?null!==e&&(e.setSelected(!e.isSelected()),e.isSelected()||(this._selected=null)):(this._selected&&this._selected.setSelected(!1),this._selected=e,this._selected&&this._selected.setSelected(!0)),this.fire("selection_changed")}},L.Control.LayersLegend=L.Control.Layers.extend({_onInputClick:function(){this._handlingClick=!0,this._layerControlInputs.reduceRight(((e,t)=>{if(t.checked)return this._map.fireEvent("legend_selected",{layer:this._getLayer(t.layerId).layer,input:t},!0),t}),0),this._handlingClick=!1,this._refocusOnMap()}}),L.control.layersLegend=(e,t,i)=>new L.Control.LayersLegend(e,t,i),L.GeoJSON.include(L.Mixin.Selectable),L.GpxGroup=L.Class.extend({options:{highlight:{color:"#ff0",opacity:1},points:[],points_options:{icon:{iconUrl:"../images/elevation-poi.png",iconSize:[12,12]}},flyToBounds:!0,legend:!1,legend_options:{position:"topright",collapsed:!1},elevation:!0,elevation_options:{theme:"yellow-theme",detached:!0,elevationDiv:"#elevation-div"},distanceMarkers:!0,distanceMarkers_options:{lazy:!0}},initialize:function(e,t){L.Util.setOptions(this,t),this._count=0,this._loadedCount=0,this._tracks=e,this._layers=L.featureGroup(),this._markers=L.featureGroup(),this._elevation=L.control.elevation(this.options.elevation_options),this._legend=L.control.layersLegend(null,null,this.options.legend_options),this.options.points.forEach((e=>L.marker(e.latlng,{icon:L.icon(this.options.points_options.icon)}).bindTooltip(e.name,{direction:"auto"}).addTo(this._markers)))},getBounds:function(){return this._layers.getBounds()},addTo:function(e){this._layers.addTo(e),this._markers.addTo(e),this._map=e,this.on("selection_changed",this._onSelectionChanged,this),this._map.on("legend_selected",this._onLegendSelected,this),this._tracks.forEach(this.addTrack,this)},addTrack:function(e){fetch(e).then((e=>e.ok&&e.text())).then((e=>this._elevation._parseFromString(e))).then((t=>{t&&(t.name=this.options.filename?e.split("/").pop().split(".").slice(0,-1).join("."):t.name||t[0]&&t[0].properties.name||e.split("/").pop().split(".").slice(0,-1).join("."),this._loadRoute(t))}))},_loadRoute:function(e){if(e){var t={color:this._uniqueColors(this._tracks.length)[this._count++],opacity:.75,weight:5,distanceMarkers:this.options.distanceMarkers_options},i=L.geoJson(e,{name:e.name||"",style:e=>t,distanceMarkers:t.distanceMarkers,originalStyle:t,filter:e=>"Point"!=e.geometry.type});this._elevation.import(this._elevation.__LGEOMUTIL).then((()=>{i.addTo(this._layers),i.eachLayer((e=>this._onEachRouteLayer(i,e))),this._onEachRouteLoaded(i)}))}},_onEachRouteLayer:function(e,t){var i=t;e.on("selected",L.bind(this._onRouteSelected,this,e,i)),i.on("mouseover",L.bind(this._onRouteMouseOver,this,e,i)),i.on("mouseout",L.bind(this._onRouteMouseOut,this,e,i)),i.on("click",L.bind(this._onRouteClick,this,e,i)),i.bindTooltip(e.options.name,{direction:"auto",sticky:!0})},_onEachRouteLoaded:function(e){this.options.legend&&this._legend.addBaseLayer(e,'<svg id="legend_'+e._leaflet_id+'" width="25" height="10" version="1.1" xmlns="http://www.w3.org/2000/svg"><line x1="0" x2="50" y1="5" y2="5" stroke="'+e.options.originalStyle.color+'" fill="transparent" stroke-width="5" /></svg> '+e.options.name),this.fire("route_loaded",{route:e}),++this._loadedCount===this._tracks.length&&(this.fire("loaded"),this.options.flyToBounds&&this._map.flyToBounds(this.getBounds(),{duration:.25,easeLinearity:.25,noMoveStart:!0}),this.options.legend&&this._legend.addTo(this._map))},highlight:function(e,t){t.setStyle(this.options.highlight),this.options.distanceMarkers&&t.addDistanceMarkers()},unhighlight:function(e,t){t.setStyle(e.options.originalStyle),this.options.distanceMarkers&&t.removeDistanceMarkers()},_onRouteMouseOver:function(e,t){e.isSelected()||(this.highlight(e,t),this.options.legend&&(this.setSelection(e),L.DomUtil.get("legend_"+e._leaflet_id).parentNode.previousSibling.click())),this.fire("route_mouseover",{route:e,polyline:t})},_onRouteMouseOut:function(e,t){e.isSelected()||this.unhighlight(e,t),this.fire("route_mouseout",{route:e,polyline:t})},_onRouteClick:function(e,t){this.setSelection(e)},_onRouteSelected:function(e,t){e.isSelected()||this.unhighlight(e,t)},_onSelectionChanged:function(e){var t=this._elevation,i=t.getContainer(),o=this.getSelection();t.clear(),o&&o.isSelected()?(i||t.addTo(this._map),o.getLayers().forEach((function(e){e instanceof L.Polyline&&(t.addData(e,!1),e.bringToFront())}))):i&&t.remove()},_onLegendSelected:function(e){var t=e.input.closest(".leaflet-control-layers-list"),i=e.layer;if(!i.isSelected()){for(var o in this.setSelection(i),i._layers)this.highlight(i,i._layers[o]);this._map.flyToBounds(e.layer.getBounds())}t.scroll({top:e.input.offsetTop-t.offsetTop||0,behavior:"smooth"}),this._layers.eachLayer((e=>{var t=L.DomUtil.get("legend_"+e._leaflet_id);t.querySelector("line").style.stroke=e.isSelected()?this.options.highlight.color:"",t.parentNode.style.fontWeight=e.isSelected()?"700":""}))},_uniqueColors:function(e){return 1===e?["#0000ff"]:new Array(e).fill(null).map(((t,i)=>this._hsvToHex(i*(1/e),1,.7)))},_hsvToHex:function(e,t,i){var o=Math.floor(6*e),n=6*e-o,s=i*(1-t),l=i*(1-n*t),r=i*(1-(1-n)*t);return{0:[i,r,s],1:[l,i,s],2:[s,i,r],3:[s,l,i],4:[r,s,i],5:[i,s,l]}[o%6].map((e=>255*e)).reduce(((e,t)=>e+(t>>4&15).toString(16)+(15&t).toString(16)),"#")},removeFrom:function(e){this._layers.removeFrom(e)}}),L.GpxGroup.include(L.Mixin.Events),L.GpxGroup.include(L.Mixin.Selection),L.gpxGroup=(e,t)=>new L.GpxGroup(e,t);
